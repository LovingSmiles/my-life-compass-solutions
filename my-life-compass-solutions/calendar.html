<!DOCTYPE html>
<html lang="en">
<head>
  
  <link rel="stylesheet" href="lcp-nav.css">
<script src="lcp-nav.js" defer></script>
  <meta charset="utf-8"/>
  <title>My Life Compass Solutions — Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="theme-color" content="#2563eb">
  <link rel="stylesheet" href="styles.css"/>
  <style>
    /* ===== Page polish (uses tokens from styles.css) ===== */
    main.wrap{ width:min(1150px, 92vw); margin-inline:auto }
    .cal-toolbar{
      position:sticky; top:calc(var(--header-h) + 6px); z-index:40;
      background: color-mix(in srgb, var(--panel) 92%, transparent);
      backdrop-filter:saturate(140%) blur(6px);
      border:1px solid var(--line); border-radius:12px; padding:8px; margin:12px 0;
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between;
      box-shadow: var(--shadow-1);
    }
    .cal-btn, .cal-grid button{
      border:1px solid color-mix(in srgb, var(--accent), #000 20%);
      background: var(--accent); color:#fff; font-weight:700;
      padding:.55rem .75rem; border-radius:10px; cursor:pointer;
      transition: transform .16s var(--ease-1), box-shadow .16s var(--ease-1);
    }
    .cal-btn:hover, .cal-grid button:hover{ transform: translateY(-1px); box-shadow: var(--shadow-2) }
    .cal-btn.ghost{ background:transparent; color:var(--accent); border-color:var(--accent) }
    .pill{ display:inline-block; border:1px solid var(--line); border-radius:999px; padding:.2rem .55rem; font-weight:700; font-size:.82rem; color:var(--muted) }
    .hidden{ display:none!important }
    .right{ text-align:right }

    .cal-year-grid{ display:grid; gap:10px; grid-template-columns:repeat(4,1fr) }
    .cal-year-card{ border:1px solid var(--line); border-radius:14px; padding:14px; background:var(--panel); box-shadow:var(--shadow-1) }
    .cal-year-card h3{ margin:.2rem 0 8px }

    .cal-grid{ display:grid; gap:8px; grid-template-columns:repeat(7,1fr) }
    .cal-head{ text-align:center; font-weight:800; color:var(--muted); text-transform:uppercase; font-size:.85rem }
    .cal-day{
      border:1px solid var(--line); border-radius:10px; background:var(--panel);
      min-height:84px; padding:6px; position:relative; display:flex; flex-direction:column; gap:6px;
      transition: box-shadow .16s var(--ease-1), transform .16s var(--ease-1);
    }
    .cal-day:hover{ box-shadow:var(--shadow-2); transform:translateY(-1px) }
    .cal-day .num{ font-weight:800 }
    .cal-day .dots{ position:absolute; right:6px; top:6px; display:flex; gap:3px }
    .dot{ width:8px; height:8px; border-radius:999px; background: color-mix(in srgb, var(--accent) 40%, var(--panel)) }
    .dot.red{ background:#ef4444 } .dot.green{ background:#22c55e } .dot.blue{ background:#2563eb } .dot.amber{ background:#f59e0b }
    .cal-day .thumbs{ display:flex; gap:4px; margin-top:auto }
    .cal-day .thumbs img{ width:26px; height:26px; object-fit:cover; border-radius:6px; border:1px solid var(--line) }
    .is-today{ outline:2px solid var(--accent); outline-offset:2px }

    .month-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px }
    .month-name{ font-size:1.2rem; font-weight:900 }
    .month-cover{
      width:100%; height:160px; border:1px solid var(--line); border-radius:12px;
      background:center/cover no-repeat var(--bg-muted);
    }

    .day-editor{ display:grid; gap:12px; grid-template-columns:1.05fr .95fr }
    @media(max-width:1000px){ .day-editor{ grid-template-columns:1fr } }
    .sticky-mini{
      position:sticky; top:calc(var(--header-h) + 58px);
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      background: color-mix(in srgb, var(--panel) 96%, transparent); padding:8px; border:1px solid var(--line);
      border-radius:12px; box-shadow: var(--shadow-1); z-index:35
    }

    .gallery{ display:grid; grid-template-columns:repeat(5,1fr); gap:8px }
    @media(max-width:900px){ .gallery{ grid-template-columns:repeat(3,1fr) } }
    .gallery img{ width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:12px; border:1px solid var(--line) }

    blockquote{ border-left:3px solid var(--accent); padding-left:10px; white-space:pre-wrap }
  </style>
</head>

<body>
  <!-- Top nav (simple inline; header.html is also supported via include.js) -->
  
  <script src="mood-switcher.js" defer></script>

  <!-- Shared header (optional; highlight active nav) -->
  <div id="site-header" data-include="header.html"></div>

  <main class="wrap">
    <section class="card" style="margin:16px 0">
      <h1>📅 Calendar</h1>
      <p class="muted">Plan as far out as you like. Click any <b>Year</b> → <b>Month</b> → <b>Day</b>. Add notes, tags, reminders, photos, and a cover + notes to months. Scripture of the Day included.</p>

      <!-- Top toolbar -->
      <div class="cal-toolbar" role="toolbar" aria-label="Calendar toolbar">
        <div class="jc-row">
          <button id="btnToYear" class="cal-btn ghost">↖ Year Grid</button>
          <button id="prev" class="cal-btn">◀ Prev</button>
          <div id="where" class="pill">—</div>
          <button id="next" class="cal-btn">Next ▶</button>
        </div>
        <div class="jc-row">
          <input id="jumpYear" type="number" min="1800" max="2600" style="width:110px" placeholder="Year">
          <button id="jumpBtn" class="cal-btn">Jump</button>
          <input id="searchBox" placeholder="Search notes/tags…" style="width:min(260px, 60vw)">
          <button id="exportBtn" class="cal-btn ghost">Export JSON</button>
          <label class="cal-btn ghost">Import JSON <input id="importFile" type="file" accept="application/json" class="hidden"></label>
          <button id="printBtn" class="cal-btn ghost">Print</button>
        </div>
      </div>
    </section>

    <!-- YEAR GRID -->
    <section id="viewYear" class="card">
      <div class="jc-row" style="justify-content:space-between">
        <div class="jc-row">
          <button id="yPrev" class="cal-btn">◀</button>
          <h2 id="yearTitle" style="margin:0 8px"></h2>
          <button id="yNext" class="cal-btn">▶</button>
        </div>
        <div class="jc-row">
          <button id="todayBtn" class="cal-btn">Today</button>
        </div>
      </div>
      <div class="cal-year-grid" id="yearMonths"></div>
    </section>

    <!-- MONTH VIEW -->
    <section id="viewMonth" class="card hidden">
      <div class="month-head">
        <div class="jc-row">
          <button id="mPrev" class="cal-btn">◀</button>
          <div class="month-name" id="monthTitle"></div>
          <button id="mNext" class="cal-btn">▶</button>
        </div>
        <div class="jc-row">
          <button id="toYearFromMonth" class="cal-btn ghost">Year</button>
        </div>
      </div>

      <div id="monthCover" class="month-cover"></div>
      <div class="jc-row" style="margin:8px 0 12px">
        <label class="btn">Upload Month Cover
          <input id="monthCoverInput" type="file" accept="image/*" class="hidden">
        </label>
        <input id="monthNotes" placeholder="Month notes / focus (saved automatically)" class="w-100">
      </div>

      <div class="cal-grid" id="monthGrid"></div>
    </section>

    <!-- DAY VIEW -->
    <section id="viewDay" class="card hidden">
      <div class="sticky-mini">
        <div id="dayTitle" class="month-name">—</div>
        <div class="jc-row">
          <button id="dPrev" class="cal-btn">◀</button>
          <button id="backToMonth" class="cal-btn ghost">Month</button>
          <button id="dNext" class="cal-btn">▶</button>
        </div>
      </div>

      <div class="day-editor">
        <!-- Left: notes + photos -->
        <div>
          <!-- Scripture of the Day -->
          <div class="jc-card" style="margin-bottom:10px">
            <div class="jc-row" style="justify-content:space-between;align-items:center">
              <h3 style="margin:.2rem 0">📖 Scripture of the Day</h3>
              <div class="jc-row">
                <button id="verseSpeak" class="cal-btn ghost" title="Read aloud">🔊 Read</button>
                <button id="verseShuffle" class="cal-btn ghost" title="Shuffle verse">🎲 Shuffle</button>
                <button id="versePin" class="cal-btn" title="Pin to this day">📌 Pin</button>
              </div>
            </div>
            <blockquote id="verseText" class="muted" style="margin:.4rem 0 0"></blockquote>
          </div>

          <h3>Notes</h3>
          <textarea id="dayNotes" rows="8" placeholder="What happens on this day? Plans, memories, gratitude…"></textarea>

          <div class="jc-grid jc-2">
            <label>Tags (comma) <input id="dayTags" placeholder="birthday, trip, scripture"/></label>
            <label>Color label
              <select id="dayColor">
                <option value="">None</option>
                <option value="blue">Blue</option>
                <option value="green">Green</option>
                <option value="red">Red</option>
                <option value="amber">Amber</option>
              </select>
            </label>
          </div>

          <div class="jc-divider"></div>

          <h3>Checklist</h3>
          <div id="todoList" class="stack-sm"></div>
          <div class="jc-row">
            <input id="todoInput" placeholder="Add a checklist item…">
            <button id="addTodo" class="cal-btn">Add</button>
          </div>

          <div class="jc-divider"></div>

          <h3>Photos</h3>
          <div class="jc-row">
            <label class="cal-btn ghost">Upload Photos
              <input id="dayPhotos" type="file" accept="image/*" multiple class="hidden">
            </label>
            <button id="clearPhotos" class="cal-btn">Clear Photos</button>
          </div>
          <div id="dayGallery" class="gallery mt-1"></div>
        </div>

        <!-- Right: reminders + upcoming -->
        <div>
          <h3>Reminders</h3>
          <div class="form-grid cols-2">
            <label>Time <input id="remTime" type="time"></label>
            <label>Message <input id="remMsg" placeholder="e.g., Call mom, Prayer, Workout"></label>
          </div>
          <div class="jc-row">
            <label>Repeat
              <select id="remRepeat">
                <option value="none">None</option>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
                <option value="yearly">Yearly</option>
              </select>
            </label>
            <button id="addRem" class="cal-btn">Add Reminder</button>
          </div>
          <div id="remList" class="stack-sm mt-1"></div>

          <div class="jc-divider"></div>

          <h3>Upcoming Reminders</h3>
          <div id="upcoming" class="stack-sm"></div>
        </div>
      </div>
    </section>

    <!-- SEARCH RESULTS -->
    <section id="viewSearch" class="card hidden">
      <h3>Search Results</h3>
      <div id="searchResults" class="stack-md"></div>
    </section>
  </main>

  <footer>
    <div class="wrap">
      <p>Guided by Faith. Strengthened by Fire. Moved by Stillness.</p>
      <p>&copy; 2025 Life Compass Pro — by LovingSmiles</p>
    </div>
  </footer>

  <!-- Brain: local-only, no network -->
  <script>
    /* ===== Helpers ===== */
    const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
    const read=(k,fb)=>{ try{return JSON.parse(localStorage.getItem(k)) ?? fb}catch{return fb} };
    const uid=()=>crypto?.randomUUID?.()||Math.random().toString(36).slice(2);
    const pad=n=>String(n).padStart(2,'0');
    const today = new Date(); const TISO = today.toISOString().slice(0,10);
    function toast(msg, ms=1800){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),ms); }
    function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

    const K='lc_calendar_v1';
    // state: { months:{'YYYY-MM':{cover,notes}}, days:{'YYYY-MM-DD':{notes,tags[],color,photos[],todos:[{id,text,done}],reminders:[{id,time,msg,repeat}],verse?}} }
    let DB = read(K, {months:{}, days:{}});
    let view = { year: today.getFullYear(), month: today.getMonth()+1, day: null };

    /* ===== Financial → Calendar integration helpers ===== */
    function addMonthsISO(iso, months){
      const [y,m,d]=iso.split('-').map(Number);
      const dt=new Date(y, m-1+months, d);
      return dt.toISOString().slice(0,10);
    }
    function firstOfNextMonthISO(fromDate=new Date()){
      const y=fromDate.getFullYear(), m=fromDate.getMonth();
      return new Date(y, m+1, 1).toISOString().slice(0,10);
    }
    function calendarLoadDB(){
      try{ return JSON.parse(localStorage.getItem(K)) || {months:{},days:{}} }catch{ return {months:{},days:{}} }
    }
    function calendarSaveDB(db){
      localStorage.setItem(K, JSON.stringify(db));
      DB=db;
    }
    function addNoteToCalendarDate(iso, text, color='blue', reminderTime='09:00'){
      const db = calendarLoadDB();
      if(!db.days[iso]) db.days[iso] = {notes:'', tags:[], color:'', photos:[], todos:[], reminders:[]};
      db.days[iso].notes = (db.days[iso].notes ? (db.days[iso].notes + '\\n') : '') + text;
      if(color) db.days[iso].color = color;
      db.days[iso].reminders.push({id: (crypto?.randomUUID?.()||Math.random().toString(36).slice(2)), time:reminderTime, msg:text, repeat:'none'});
      calendarSaveDB(db);
    }
    function addDebtPayoffsToCalendar(sim, startAtNextMonth=true){
      if(!sim || !sim.schedules) return;
      const startISO = startAtNextMonth ? firstOfNextMonthISO(new Date()) : new Date().toISOString().slice(0,10);
      const sYear = +startISO.slice(0,4), sMonth = +startISO.slice(5,7);
      Object.entries(sim.schedules).forEach(([name, sched])=>{
        if(!sched.length) return;
        const payoffMonthIndex = sched[sched.length-1].m - 1;
        const payoffDate = new Date(sYear, sMonth-1 + payoffMonthIndex, 1);
        const iso = payoffDate.toISOString().slice(0,10);
        addNoteToCalendarDate(iso, `🎉 Payoff: ${name}`, 'green', '09:00');
        const db = calendarLoadDB();
        db.days[iso].tags = Array.from(new Set([...(db.days[iso].tags||[]), 'payoff','finance','win']));
        calendarSaveDB(db);
      });
    }
    function addMonthlyPaymentRemindersToCalendar(sim, dom=1, startAtNextMonth=true){
      if(!sim || !sim.schedules) return;
      const startISO = startAtNextMonth ? firstOfNextMonthISO(new Date()) : new Date().toISOString().slice(0,10);
      const sYear = +startISO.slice(0,4), sMonth = +startISO.slice(5,7);
      Object.entries(sim.schedules).forEach(([name, sched])=>{
        const months = sched.length;
        for(let i=0;i<months;i++){
          const when = new Date(sYear, sMonth-1 + i, dom);
          const iso = when.toISOString().slice(0,10);
          addNoteToCalendarDate(iso, `💳 ${name} — Payment due`, 'blue', '08:00');
        }
      });
    }

    /* ===== Year grid (200y span) ===== */
    const MIN_YEAR = today.getFullYear()-100, MAX_YEAR = today.getFullYear()+100;
    function monthKey(y,m){ return `${y}-${pad(m)}` }
    function dayKey(y,m,d){ return `${y}-${pad(m)}-${pad(d)}` }

    function renderYear(){
      $('#viewSearch').classList.add('hidden');
      $('#viewDay').classList.add('hidden');
      $('#viewMonth').classList.add('hidden');
      $('#viewYear').classList.remove('hidden');

      $('#yearTitle').textContent = view.year;
      $('#where').textContent = `Year ${view.year}`;
      const ym = $('#yearMonths'); ym.innerHTML='';

      const names = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      for(let m=1;m<=12;m++){
        const card = document.createElement('div');
        card.className='cal-year-card';
        card.innerHTML = `
          <h3>${names[m-1]} ${view.year}</h3>
          <div class="cal-grid" style="grid-template-columns:repeat(7,1fr)">
            ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(h=>`<div class="cal-head">${h}</div>`).join('')}
            ${(()=>{
              const first = new Date(view.year,m-1,1).getDay();
              const days = new Date(view.year,m,0).getDate();
              let html = '';
              for(let i=0;i<first;i++) html += '<div></div>';
              for(let d=1;d<=days;d++){
                const dk = dayKey(view.year,m,d);
                const has = DB.days[dk] || {};
                html += `
                  <div class="cal-day">
                    <div class="jc-row" style="justify-content:space-between">
                      <div class="num">${d}</div>
                      <div class="dots">
                        ${has.color?`<span class="dot ${has.color}"></span>`:''}
                        ${has.reminders?.length?`<span class="dot blue" title="${has.reminders.length} reminder(s)"></span>`:''}
                        ${has.notes?`<span class="dot green" title="notes"></span>`:''}
                      </div>
                    </div>
                    <div class="thumbs">${(has.photos||[]).slice(0,3).map(u=>`<img src="${u}" alt="">`).join('')}</div>
                    <button class="cal-btn" data-open="${view.year}-${pad(m)}-${pad(d)}">Open</button>
                  </div>`;
              }
              return html;
            })()}
          </div>
          <div class="jc-row" style="margin-top:8px; justify-content:flex-end">
            <button class="cal-btn" data-month="${m}">Open Month</button>
          </div>`;
        ym.appendChild(card);
      }

      ym.onclick = (e)=>{
        const open = e.target.getAttribute('data-open');
        const m = e.target.getAttribute('data-month');
        if(open){ const [y,mm,dd]=open.split('-').map(Number); openDay(y,mm,dd); }
        if(m){ openMonth(view.year, +m); }
      };
    }

    /* ===== Month view ===== */
    function openMonth(y,m){
      view.year=y; view.month=m; view.day=null;
      $('#viewYear').classList.add('hidden');
      $('#viewDay').classList.add('hidden');
      $('#viewMonth').classList.remove('hidden');
      $('#where').textContent = `${y} — ${new Date(y,m-1,1).toLocaleString(undefined,{month:'long'})}`;
      $('#monthTitle').textContent = `${new Date(y,m-1,1).toLocaleString(undefined,{month:'long'})} ${y}`;

      const mk = monthKey(y,m);
      const cover = DB.months[mk]?.cover || '';
      $('#monthCover').style.backgroundImage = cover ? `url(${cover})` : 'none';
      $('#monthNotes').value = DB.months[mk]?.notes || '';

      const grid=$('#monthGrid'); grid.innerHTML='';
      ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(h=>{ const div=document.createElement('div'); div.className='cal-head'; div.textContent=h; grid.appendChild(div); });

      const first = new Date(y,m-1,1).getDay();
      const days = new Date(y,m,0).getDate();
      for(let i=0;i<first;i++){ grid.appendChild(document.createElement('div')); }
      for(let d=1; d<=days; d++){
        const dk = dayKey(y,m,d);
        const cell = document.createElement('div'); cell.className='cal-day';
        if(dk===TISO) cell.classList.add('is-today');
        const has = DB.days[dk] || {};
        const pics = (has.photos||[]).slice(0,3);
        cell.innerHTML = `
          <div class="jc-row" style="justify-content:space-between"><div class="num">${d}</div>
            <div class="dots">
              ${has.color?`<span class="dot ${has.color}"></span>`:''}
              ${has.reminders?.length?`<span class="dot blue" title="${has.reminders.length} reminder(s)"></span>`:''}
              ${has.notes?`<span class="dot green" title="notes"></span>`:''}
            </div>
          </div>
          <div class="thumbs">${pics.map(u=>`<img src="${u}" alt="">`).join('')}</div>
          <button class="cal-btn" data-open="${d}">Open</button>
        `;
        grid.appendChild(cell);
      }
    }

    /* Month controls */
    $('#mPrev').addEventListener('click', ()=>{ let y=view.year, m=view.month-1; if(m<1){m=12; y--} if(y<MIN_YEAR)return; openMonth(y,m); });
    $('#mNext').addEventListener('click', ()=>{ let y=view.year, m=view.month+1; if(m>12){m=1; y++} if(y>MAX_YEAR)return; openMonth(y,m); });
    $('#toYearFromMonth').addEventListener('click', ()=> renderYear());

    /* Month cover/notes save */
    $('#monthCoverInput').addEventListener('change', async ()=>{
      const f = $('#monthCoverInput').files?.[0]; if(!f) return;
      const url = await fileToDataURL(f);
      const mk = monthKey(view.year,view.month);
      DB.months[mk] = DB.months[mk] || {};
      DB.months[mk].cover = url; save(K,DB);
      $('#monthCover').style.backgroundImage = `url(${url})`;
    });
    $('#monthNotes').addEventListener('input', ()=>{
      const mk = monthKey(view.year,view.month);
      DB.months[mk] = DB.months[mk] || {};
      DB.months[mk].notes = $('#monthNotes').value;
      save(K,DB);
    });

    /* ===== Day view ===== */
    function openDay(y,m,d){
      view.year=y; view.month=m; view.day=d;
      $('#viewMonth').classList.add('hidden');
      $('#viewSearch').classList.add('hidden');
      $('#viewDay').classList.remove('hidden');

      $('#dayTitle').textContent = new Date(y,m-1,d).toLocaleDateString(undefined,{weekday:'long', month:'long', day:'numeric', year:'numeric'});
      $('#where').textContent = `${y}-${pad(m)}-${pad(d)}`;

      const dk = dayKey(y,m,d);
      const data = DB.days[dk] || {};
      $('#dayNotes').value = data.notes || '';
      $('#dayTags').value  = (data.tags||[]).join(', ');
      $('#dayColor').value = data.color || '';

      loadVerseForDay(y,m,d);
      renderTodos(data.todos||[]);
      renderDayGallery(data.photos||[]);
      renderReminders(data.reminders||[]);
      renderUpcoming();
    }

    /* Day navigation */
    $('#dPrev').addEventListener('click', ()=> stepDay(-1));
    $('#dNext').addEventListener('click', ()=> stepDay(+1));
    $('#backToMonth').addEventListener('click', ()=> openMonth(view.year, view.month));
    document.addEventListener('keydown', (e)=>{
      if($('#viewMonth').classList.contains('hidden') && $('#viewDay').classList.contains('hidden')) return;
      if(e.key==='ArrowLeft') { if(!$('#viewDay').classList.contains('hidden')) stepDay(-1); else stepMonth(-1); }
      if(e.key==='ArrowRight'){ if(!$('#viewDay').classList.contains('hidden')) stepDay(+1); else stepMonth(+1); }
      if(e.key==='Escape' && !$('#viewDay').classList.contains('hidden')) openMonth(view.year, view.month);
    });
    function stepMonth(delta){
      let y=view.year, m=view.month+delta; if(m<1){m=12; y--} if(m>12){m=1; y++}
      if(y<MIN_YEAR || y>MAX_YEAR) return; openMonth(y,m);
    }
    function stepDay(delta){
      let y=view.year, m=view.month, d=view.day+delta;
      const dim = new Date(y,m,0).getDate();
      if(d<1){ m--; if(m<1){m=12; y--} d=new Date(y,m,0).getDate(); }
      if(d>dim){ d=1; m++; if(m>12){m=1; y++} }
      if(y<MIN_YEAR || y>MAX_YEAR) return;
      openDay(y,m,d);
    }

    /* Day field auto-save */
    $('#dayNotes').addEventListener('input', saveDay);
    $('#dayTags').addEventListener('input', saveDay);
    $('#dayColor').addEventListener('change', saveDay);
    function saveDay(){
      if(view.day==null) return;
      const dk = dayKey(view.year,view.month,view.day);
      DB.days[dk] = DB.days[dk] || {todos:[], photos:[], reminders:[]};
      DB.days[dk].notes = $('#dayNotes').value;
      DB.days[dk].tags  = $('#dayTags').value.split(',').map(s=>s.trim()).filter(Boolean);
      DB.days[dk].color = $('#dayColor').value || '';
      save(K,DB);
      openMonth(view.year, view.month); // reflect dots/cover
    }

    /* Photos */
    $('#dayPhotos').addEventListener('change', async ()=>{
      const files = Array.from($('#dayPhotos').files||[]).slice(0,20), imgs=[];
      for(const f of files){ if(f.type.startsWith('image/')) imgs.push(await fileToDataURL(f)); }
      const dk = dayKey(view.year,view.month,view.day);
      DB.days[dk] = DB.days[dk] || {todos:[], photos:[], reminders:[]};
      DB.days[dk].photos = (DB.days[dk].photos||[]).concat(imgs);
      save(K,DB);
      renderDayGallery(DB.days[dk].photos);
      openMonth(view.year, view.month);
      $('#dayPhotos').value='';
    });
    $('#clearPhotos').addEventListener('click', ()=>{
      if(!confirm('Remove all photos for this day?')) return;
      const dk = dayKey(view.year,view.month,view.day);
      if(DB.days[dk]) DB.days[dk].photos=[];
      save(K,DB); renderDayGallery([]); openMonth(view.year, view.month);
    });
    function renderDayGallery(list){
      const g=$('#dayGallery'); g.innerHTML='';
      list.forEach((u,i)=>{
        const img=new Image(); img.src=u; img.alt="Photo";
        img.onclick=()=>{ if(confirm('Delete this photo?')){ list.splice(i,1); const dk=dayKey(view.year,view.month,view.day); DB.days[dk].photos=list; save(K,DB); renderDayGallery(list); openMonth(view.year, view.month); } };
        g.appendChild(img);
      });
    }

    /* Todos */
    $('#addTodo').addEventListener('click', ()=>{
      const t=$('#todoInput').value.trim(); if(!t) return;
      const dk=dayKey(view.year,view.month,view.day);
      DB.days[dk] = DB.days[dk] || {todos:[], photos:[], reminders:[]};
      DB.days[dk].todos.push({id:uid(), text:t, done:false});
      save(K,DB); $('#todoInput').value=''; renderTodos(DB.days[dk].todos);
    });
    function renderTodos(list){
      const host=$('#todoList'); host.innerHTML='';
      if(!list.length){ host.innerHTML='<div class="muted">No items yet.</div>'; return; }
      list.forEach(it=>{
        const row=document.createElement('div'); row.className='jc-row'; row.style.justifyContent='space-between';
        row.innerHTML = `
          <label class="jc-row" style="gap:6px; align-items:center">
            <input type="checkbox" ${it.done?'checked':''} data-t="${it.id}">
            <span style="text-decoration:${it.done?'line-through':'none'}">${(it.text||'').replace(/</g,'&lt;')}</span>
          </label>
          <button class="btn btn-ghost" data-del="${it.id}">Delete</button>`;
        host.appendChild(row);
      });
      host.onclick = (e)=>{
        const id = e.target.getAttribute('data-t'); const del = e.target.getAttribute('data-del');
        const dk=dayKey(view.year,view.month,view.day);
        const arr = DB.days[dk].todos;
        if(id){ const it=arr.find(x=>x.id===id); if(it){ it.done = !it.done; save(K,DB); renderTodos(arr); } }
        if(del){ DB.days[dk].todos = arr.filter(x=>x.id!==del); save(K,DB); renderTodos(DB.days[dk].todos); }
      };
    }

    /* Reminders (local polling + Notification API) */
    $('#addRem').addEventListener('click', ()=>{
      const time=$('#remTime').value, msg=$('#remMsg').value.trim(), rep=$('#remRepeat').value;
      if(!time || !msg) { alert('Time and message required'); return; }
      const dk=dayKey(view.year,view.month,view.day);
      DB.days[dk] = DB.days[dk] || {todos:[], photos:[], reminders:[]};
      DB.days[dk].reminders.push({id:uid(), time, msg, repeat:rep});
      save(K,DB); $('#remMsg').value=''; renderReminders(DB.days[dk].reminders); renderUpcoming(); openMonth(view.year, view.month);
      maybeAskNotify();
    });
    function renderReminders(list){
      const host=$('#remList'); host.innerHTML='';
      if(!list.length){ host.innerHTML='<div class="muted">No reminders yet.</div>'; return; }
      list.forEach(r=>{
        const row=document.createElement('div'); row.className='jc-row'; row.style.justifyContent='space-between';
        row.innerHTML = `<div>${r.time} • ${r.msg} <span class="pill">${r.repeat}</span></div>
                         <button class="btn btn-ghost" data-r="${r.id}">Delete</button>`;
        host.appendChild(row);
      });
      host.onclick=(e)=>{
        const id = e.target.getAttribute('data-r'); if(!id) return;
        const dk=dayKey(view.year,view.month,view.day);
        DB.days[dk].reminders = (DB.days[dk].reminders||[]).filter(x=>x.id!==id);
        save(K,DB); renderReminders(DB.days[dk].reminders); renderUpcoming(); openMonth(view.year, view.month);
      };
    }
    function renderUpcoming(){
      const up = [];
      Object.keys(DB.days).forEach(dk=>{
        const arr = DB.days[dk].reminders||[];
        arr.forEach(r=> up.push({dk, ...r}));
      });
      up.sort((a,b)=> (a.dk+a.time).localeCompare(b.dk+b.time));
      const host=$('#upcoming'); host.innerHTML='';
      (up.slice(0,12)).forEach(u=>{
        const div=document.createElement('div'); div.className='jc-row'; div.style.justifyContent='space-between';
        div.innerHTML = `<div><b>${u.dk}</b> • ${u.time} — ${u.msg} <span class="pill">${u.repeat}</span></div>
                         <button class="btn btn-ghost" data-go="${u.dk}">Open</button>`;
        host.appendChild(div);
      });
      host.onclick=(e)=>{
        const dk=e.target.getAttribute('data-go'); if(!dk) return;
        const [y,m,d]=dk.split('-').map(Number); openDay(y,m,d);
      };
    }
    let tickTimer=null;
    function startTicker(){
      if(tickTimer) clearInterval(tickTimer);
      tickTimer = setInterval(checkReminders, 60000);
      checkReminders();
    }
    function checkReminders(){
      const now = new Date();
      const iso = now.toISOString().slice(0,10);
      const hh = pad(now.getHours()), mm = pad(now.getMinutes()), t=`${hh}:${mm}`;
      const list = (DB.days[iso]?.reminders||[]).filter(r=>r.time===t);
      if(!list.length) return;
      list.forEach(r=>{
        toast(`⏰ ${t} — ${r.msg}`);
        if('Notification' in window && Notification.permission==='granted'){
          new Notification('Life Compass — Reminder', { body: r.msg });
        }
      });
    }
    function maybeAskNotify(){
      if(!('Notification' in window)) return;
      if(Notification.permission==='default'){
        Notification.requestPermission().then(()=>{});
      }
    }

    /* ===== Scripture of the Day (compact, valid list) ===== */
    const VERSES = [
      "The Lord is my shepherd; I shall not want. — Psalm 23:1",
      "Be still, and know that I am God. — Psalm 46:10",
      "Trust in the Lord with all your heart… — Proverbs 3:5–6",
      "I can do all things through Christ who strengthens me. — Philippians 4:13",
      "Do not be anxious about anything… — Philippians 4:6–7",
      "The joy of the Lord is your strength. — Nehemiah 8:10",
      "Cast all your anxiety on Him because He cares for you. — 1 Peter 5:7",
      "Let all that you do be done in love. — 1 Corinthians 16:14",
      "Your word is a lamp to my feet… — Psalm 119:105",
      "Those who hope in the Lord will renew their strength… — Isaiah 40:31",
      "If God is for us, who can be against us? — Romans 8:31",
      "The steadfast love of the Lord never ceases… — Lamentations 3:22–23",
      "Commit your work to the Lord… — Proverbs 16:3",
      "We love because He first loved us. — 1 John 4:19",
      "Peace I leave with you; my peace I give to you. — John 14:27",
      "My God shall supply all your need. — Philippians 4:19",
      "Pray without ceasing. — 1 Thessalonians 5:17",
      "Be strong and courageous… for the Lord your God is with you. — Joshua 1:9",
      "God shall wipe away all tears from their eyes. — Revelation 21:4",
      "The Lord is my light and my salvation; whom shall I fear? — Psalm 27:1"
    ];
    function autoVerseFor(y,m,d){
      const date = new Date(y, m-1, d);
      const start = new Date(date.getFullYear(), 0, 0);
      const day = Math.floor((date - start) / 86400000);
      return VERSES[day % VERSES.length];
    }
    function setVerseUI(text){ const el=document.getElementById('verseText'); if(el) el.textContent=text; }
    function loadVerseForDay(y,m,d){
      const dk = dayKey(y,m,d);
      const pinned = DB.days[dk]?.verse;
      setVerseUI(pinned || autoVerseFor(y,m,d));
    }
    function pinVerseForDay(){
      const text = (document.getElementById('verseText')?.textContent||'').trim();
      if(!text) return;
      const dk = dayKey(view.year, view.month, view.day);
      DB.days[dk] = DB.days[dk] || {todos:[], photos:[], reminders:[]};
      DB.days[dk].verse = text;
      save(K,DB);
      toast('📌 Verse pinned to this day');
    }
    function shuffleVerseForDay(){ setVerseUI(VERSES[Math.floor(Math.random()*VERSES.length)]); }
    function speak(text){
      try{ const u=new SpeechSynthesisUtterance(text); u.rate=1; u.pitch=1; speechSynthesis.cancel(); speechSynthesis.speak(u); }catch{}
    }
    document.getElementById('versePin')    ?.addEventListener('click', pinVerseForDay);
    document.getElementById('verseShuffle')?.addEventListener('click', shuffleVerseForDay);
    document.getElementById('verseSpeak')  ?.addEventListener('click', ()=> speak(document.getElementById('verseText').textContent||''));

    /* Export / Import / Print */
    $('#exportBtn').addEventListener('click', ()=>{
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([JSON.stringify(DB,null,2)],{type:'application/json'}));
      a.download='calendar.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),800);
    });
    $('#importFile').addEventListener('change', ()=>{
      const f=$('#importFile').files?.[0]; if(!f) return;
      const fr=new FileReader();
      fr.onload=()=>{
        try{
          const data=JSON.parse(fr.result);
          if(data && data.days && data.months){ DB=data; save(K,DB); refresh(); toast('Imported ✅'); }
          else alert('Bad import file');
        }catch{ alert('Bad import file'); }
      };
      fr.readAsText(f);
    });
    $('#printBtn').addEventListener('click', ()=>{
      if(!$('#viewMonth').classList.contains('hidden')) window.print();
      else if(!$('#viewDay').classList.contains('hidden')) window.print();
      else { openMonth(view.year,1); setTimeout(()=>window.print(),150); }
    });

    /* Search */
    $('#searchBox').addEventListener('input', ()=>{
      const q=$('#searchBox').value.trim().toLowerCase();
      if(!q){ $('#viewSearch').classList.add('hidden'); return; }
      const host=$('#searchResults'); host.innerHTML=''; $('#viewSearch').classList.remove('hidden');
      let found=0;
      Object.entries(DB.days).forEach(([dk,day])=>{
        const hay = [day.notes||'', ...(day.tags||[])].join(' ').toLowerCase();
        if(!hay.includes(q)) return;
        found++;
        const card=document.createElement('div'); card.className='jc-card';
        card.innerHTML = `<div class="jc-row" style="justify-content:space-between">
          <div><b>${dk}</b> ${(day.tags||[]).length? '• '+day.tags.map(t=>`<span class="tag">${t}</span>`).join(' '):''}</div>
          <button class="btn btn-ghost" data-go="${dk}">Open</button>
        </div>
        ${day.notes? `<p class="muted" style="white-space:pre-wrap">${day.notes.replace(/</g,'&lt;')}</p>`:''}`;
        host.appendChild(card);
      });
      if(!found) host.innerHTML = '<div class="muted">No matches.</div>';
      host.onclick=(e)=>{ const dk=e.target.getAttribute('data-go'); if(!dk) return; const [y,m,d]=dk.split('-').map(Number); openDay(y,m,d); };
    });

    /* Year toolbar buttons */
    $('#yPrev').addEventListener('click', ()=>{ if(view.year>MIN_YEAR){ view.year--; renderYear(); } });
    $('#yNext').addEventListener('click', ()=>{ if(view.year<MAX_YEAR){ view.year++; renderYear(); } });
    $('#todayBtn').addEventListener('click', ()=>{ view.year=today.getFullYear(); openMonth(view.year, today.getMonth()+1); });
    $('#btnToYear').addEventListener('click', renderYear);
    $('#prev').addEventListener('click', ()=>{ if(!$('#viewMonth').classList.contains('hidden')) stepMonth(-1); else if(!$('#viewDay').classList.contains('hidden')) stepDay(-1); else { view.year=Math.max(MIN_YEAR, view.year-1); renderYear(); } });
    $('#next').addEventListener('click', ()=>{ if(!$('#viewMonth').classList.contains('hidden')) stepMonth(+1); else if(!$('#viewDay').classList.contains('hidden')) stepDay(+1); else { view.year=Math.min(MAX_YEAR, view.year+1); renderYear(); } });
    $('#jumpBtn').addEventListener('click', ()=>{ const y=parseInt($('#jumpYear').value,10); if(!y || y<MIN_YEAR || y>MAX_YEAR){ alert(`Enter ${MIN_YEAR}–${MAX_YEAR}`); return; } view.year=y; renderYear(); });

    /* Month grid click (open day) */
    $('#monthGrid').addEventListener('click', (e)=>{
      const d = e.target.getAttribute('data-open') || (e.target.closest('button')?.getAttribute('data-open'));
      if(d){ openDay(view.year, view.month, +d); }
    });

    /* Utilities */
    function refresh(){
      if(!$('#viewYear').classList.contains('hidden')) renderYear();
      if(!$('#viewMonth').classList.contains('hidden')) openMonth(view.year, view.month);
      if(!$('#viewDay').classList.contains('hidden')) openDay(view.year, view.month, view.day);
      renderUpcoming();
    }

    /* Init */
    function init(){
      renderYear();
      startTicker();
      maybeAskNotify();
      // open current month immediately
      openMonth(view.year, view.month);
    }
    document.addEventListener('DOMContentLoaded', init);

    /* Logout passthrough */
    document.addEventListener('click', (e)=>{
      if(e.target?.id==='logoutBtn'){
        e.preventDefault();
        localStorage.removeItem('lc_session_v1');
        sessionStorage.removeItem('lc_session_v1');
        alert('✅ You have been logged out.');
        (window.top||window).location.href='auth.html';
      }
    });
  </script>

  <!-- Optional: include shared header loader -->
  <script src="include.js" defer></script>
  <script src="lifecompass.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</body>
</html>